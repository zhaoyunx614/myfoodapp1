<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Personalized Map Destinations
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet"/>
  <style>
   body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    #map {
      height: 40vh;
      width: 100%;
      z-index: 10;
    }
    @media (min-width: 768px) {
      #map {
        height: 100vh;
        width: 60vw;
      }
    }
  </style>
 </head>
 <body class="bg-gray-100 text-black flex flex-col min-h-screen overflow-hidden font-sans">
  <header class="bg-white shadow sticky top-0 z-50 flex justify-between items-center px-4 py-3">
   <h1 class="text-lg font-semibold">
    Personalized Map Destinations
   </h1>
   <button aria-label="Toggle edit mode" class="flex items-center gap-2 bg-blue-600 text-white rounded-lg px-3 py-1.5 text-sm hover:bg-blue-700 transition" id="editButton">
    <i class="fas fa-edit">
    </i>
    Edit
   </button>
  </header>
  <main class="flex flex-col md:flex-row flex-1 overflow-hidden">
   <div class="relative" id="map">
   </div>
   <section class="bg-white rounded-t-xl md:rounded-none md:rounded-l-xl md:w-2/5 h-[60vh] md:h-full overflow-y-auto shadow-inner relative">
    <div class="flex justify-between items-center border-b border-gray-300 px-4 py-3 sticky top-0 bg-white z-20">
     <h2 class="text-lg font-semibold">
      My Destinations
     </h2>
     <div class="edit-buttons hidden flex gap-2">
      <button class="flex items-center gap-2 bg-gray-200 text-blue-600 rounded-lg px-3 py-1.5 text-sm hover:bg-gray-300 transition" id="shareButton">
       <i class="fas fa-share-alt">
       </i>
       Share
      </button>
      <button class="bg-blue-600 text-white rounded-lg px-3 py-1.5 text-sm hover:bg-blue-700 transition" id="doneButton">
       Done
      </button>
     </div>
    </div>
    <div class="flex flex-col items-center justify-center p-8 text-gray-400 h-full" id="emptyState">
     <i class="fas fa-map-marker-alt text-6xl mb-4 opacity-50">
     </i>
     <h3 class="text-xl font-semibold mb-2">
      No destinations yet
     </h3>
     <p class="text-center max-w-xs">
      Add your first destination by tapping the + button
     </p>
    </div>
    <ul class="location-list divide-y divide-gray-200" id="locationList">
    </ul>
   </section>
  </main>
  <!-- Add Location Modal -->
  <div aria-labelledby="addLocationTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50 p-4" id="addLocationModal" role="dialog">
   <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 flex flex-col">
    <header class="flex justify-between items-center border-b border-gray-300 pb-3 mb-4">
     <h3 class="text-lg font-semibold" id="addLocationTitle">
      Add New Destination
     </h3>
     <button aria-label="Close add location modal" class="text-2xl font-bold text-gray-600 hover:text-gray-900" data-dismiss="modal">
      ×
     </button>
    </header>
    <form class="flex flex-col gap-4" id="locationForm">
     <div>
      <label class="block mb-1 font-medium text-gray-700 text-sm" for="locationName">
       Name
       <span class="text-red-500">
        *
       </span>
      </label>
      <input class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="locationName" placeholder="e.g. Favorite Cafe" required="" type="text"/>
     </div>
     <div>
      <label class="block mb-1 font-medium text-gray-700 text-sm" for="locationAddress">
       Address
      </label>
      <input autocomplete="off" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="locationAddress" placeholder="e.g. 123 Main St, City, Country" type="text"/>
     </div>
     <div>
      <label class="block mb-1 font-medium text-gray-700 text-sm" for="locationLatitude">
       Latitude
      </label>
      <input autocomplete="off" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="locationLatitude" max="90" min="-90" placeholder="e.g. 34.0522" step="any" type="number"/>
     </div>
     <div>
      <label class="block mb-1 font-medium text-gray-700 text-sm" for="locationLongitude">
       Longitude
      </label>
      <input autocomplete="off" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="locationLongitude" max="180" min="-180" placeholder="e.g. -118.2437" step="any" type="number"/>
     </div>
     <div>
      <label class="block mb-1 font-medium text-gray-700 text-sm" for="locationDescription">
       Description
      </label>
      <textarea class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm resize-y focus:outline-none focus:ring-2 focus:ring-blue-500" id="locationDescription" placeholder="Add some notes about this place..." rows="4"></textarea>
     </div>
     <div>
      <label class="block mb-1 font-medium text-gray-700 text-sm" for="locationImage">
       Image
      </label>
      <div aria-label="Add image preview, click to upload" class="w-full h-36 border-2 border-dashed border-gray-300 rounded-lg flex flex-col justify-center items-center cursor-pointer overflow-hidden relative" id="imagePreview" role="button" tabindex="0">
       <div class="flex flex-col items-center text-gray-400 text-sm select-none">
        <i class="fas fa-image text-3xl mb-1">
        </i>
        <span>
         Tap to add image
        </span>
       </div>
      </div>
      <input accept="image/*" aria-hidden="true" class="hidden" id="fileInput" type="file"/>
     </div>
     <fieldset class="border border-gray-300 rounded-lg p-4">
      <legend class="font-medium text-gray-700 text-sm mb-2 px-2">
       Working Hours
      </legend>
      <div class="grid grid-cols-1 gap-3 max-h-48 overflow-y-auto">
       <div class="flex items-center gap-2">
        <label class="w-20 text-gray-700 text-sm" for="hoursMonday">
         Monday
        </label>
        <input class="flex-1 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="hoursMonday" placeholder="e.g. 09:00-17:00 or Closed" type="text"/>
       </div>
       <div class="flex items-center gap-2">
        <label class="w-20 text-gray-700 text-sm" for="hoursTuesday">
         Tuesday
        </label>
        <input class="flex-1 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="hoursTuesday" placeholder="e.g. 09:00-17:00 or Closed" type="text"/>
       </div>
       <div class="flex items-center gap-2">
        <label class="w-20 text-gray-700 text-sm" for="hoursWednesday">
         Wednesday
        </label>
        <input class="flex-1 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="hoursWednesday" placeholder="e.g. 09:00-17:00 or Closed" type="text"/>
       </div>
       <div class="flex items-center gap-2">
        <label class="w-20 text-gray-700 text-sm" for="hoursThursday">
         Thursday
        </label>
        <input class="flex-1 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="hoursThursday" placeholder="e.g. 09:00-17:00 or Closed" type="text"/>
       </div>
       <div class="flex items-center gap-2">
        <label class="w-20 text-gray-700 text-sm" for="hoursFriday">
         Friday
        </label>
        <input class="flex-1 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="hoursFriday" placeholder="e.g. 09:00-17:00 or Closed" type="text"/>
       </div>
       <div class="flex items-center gap-2">
        <label class="w-20 text-gray-700 text-sm" for="hoursSaturday">
         Saturday
        </label>
        <input class="flex-1 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="hoursSaturday" placeholder="e.g. 09:00-17:00 or Closed" type="text"/>
       </div>
       <div class="flex items-center gap-2">
        <label class="w-20 text-gray-700 text-sm" for="hoursSunday">
         Sunday
        </label>
        <input class="flex-1 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" id="hoursSunday" placeholder="e.g. 09:00-17:00 or Closed" type="text"/>
       </div>
      </div>
     </fieldset>
     <div class="flex items-center gap-2">
      <input type="checkbox" id="visitedCheckbox" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"/>
      <label for="visitedCheckbox" class="text-gray-700 text-sm select-none">Mark as visited</label>
     </div>
     <div class="flex justify-end gap-2 mt-2">
      <button class="bg-gray-200 text-gray-700 rounded-lg px-4 py-2 text-sm hover:bg-gray-300 transition" data-dismiss="modal" type="button">
       Cancel
      </button>
      <button class="bg-blue-600 text-white rounded-lg px-4 py-2 text-sm hover:bg-blue-700 transition" id="saveLocationButton" type="submit">
       Save
      </button>
     </div>
    </form>
   </div>
  </div>
  <!-- Location Detail Modal -->
  <div aria-labelledby="locationDetailTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50 p-4" id="locationDetailModal" role="dialog">
   <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 flex flex-col">
    <header class="flex justify-between items-center border-b border-gray-300 pb-3 mb-4">
     <h3 class="text-lg font-semibold" id="locationDetailTitle">
      Location Details
     </h3>
     <button aria-label="Close location details modal" class="text-2xl font-bold text-gray-600 hover:text-gray-900" data-dismiss="modal">
      ×
     </button>
    </header>
    <img alt="Location image placeholder" class="w-full h-48 rounded-lg object-cover mb-4" height="320" id="detailImage" src="https://storage.googleapis.com/a1aa/image/cbf389b8-c344-42f2-8975-b6de62438be6.jpg" width="400"/>
    <h2 class="text-xl font-semibold mb-1" id="detailName">
     Location Name
    </h2>
    <a class="text-blue-600 underline mb-2 block" href="#" id="detailAddress" rel="noopener noreferrer" target="_blank">
     Address
    </a>
    <p class="text-gray-700 mb-4 leading-relaxed" id="detailDescription">
     Description
    </p>
    <div class="text-gray-400 mb-4 text-sm" id="detailCoords">
     Coordinates
    </div>
    <fieldset class="border border-gray-300 rounded-lg p-4 mb-4">
     <legend class="font-medium text-gray-700 text-sm mb-2 px-2">
      Working Hours
     </legend>
     <ul class="text-gray-700 text-sm space-y-1" id="detailWorkingHours">
     </ul>
    </fieldset>
    <div class="flex justify-between gap-2 mt-auto">
     <button class="flex items-center gap-2 bg-gray-200 text-blue-600 rounded-lg px-3 py-2 text-sm hover:bg-gray-300 transition" id="viewOnMapButton">
      <i class="fas fa-map-marker-alt">
      </i>
      View on Map
     </button>
     <button class="flex items-center gap-2 bg-blue-600 text-white rounded-lg px-3 py-2 text-sm hover:bg-blue-700 transition" id="openInGoogleMapsButton">
      <i class="fas fa-external-link-alt">
      </i>
      Open in Maps
     </button>
    </div>
   </div>
  </div>
  <!-- Share Modal -->
  <div aria-labelledby="shareModalTitle" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50 p-4" id="shareModal" role="dialog">
   <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 flex flex-col">
    <header class="flex justify-between items-center border-b border-gray-300 pb-3 mb-4">
     <h3 class="text-lg font-semibold" id="shareModalTitle">
      Share Destinations
     </h3>
     <button aria-label="Close share modal" class="text-2xl font-bold text-gray-600 hover:text-gray-900" data-dismiss="modal">
      ×
     </button>
    </header>
    <div class="flex flex-col gap-4">
     <button class="flex items-center gap-2 bg-blue-600 text-white rounded-lg px-4 py-2 text-sm hover:bg-blue-700 transition" id="exportPdfButton">
      <i class="fas fa-file-pdf">
      </i>
      Export as PDF
     </button>
     <button class="flex items-center gap-2 bg-gray-200 text-blue-600 rounded-lg px-4 py-2 text-sm hover:bg-gray-300 transition" id="exportJsonButton">
      <i class="fas fa-file-code">
      </i>
      Export as JSON
     </button>
     <button class="flex items-center gap-2 bg-gray-200 text-blue-600 rounded-lg px-4 py-2 text-sm hover:bg-gray-300 transition" id="exportTextButton">
      <i class="fas fa-file-alt">
      </i>
      Export as Text
     </button>
    </div>
   </div>
  </div>
  <!-- Context Menu -->
  <div aria-label="Location options" class="absolute bg-white rounded-lg shadow-lg p-1 z-50 hidden w-44" id="menuPanel" role="menu">
   <div class="menu-item flex items-center gap-2 px-4 py-2 cursor-pointer hover:bg-gray-100 text-gray-700" id="editMenuItem" role="menuitem" tabindex="0">
    <i class="fas fa-edit">
    </i>
    Edit
   </div>
   <div class="menu-item flex items-center gap-2 px-4 py-2 cursor-pointer hover:bg-gray-100 text-red-600" id="deleteMenuItem" role="menuitem" tabindex="0">
    <i class="fas fa-trash">
    </i>
    Delete
   </div>
   <div class="menu-item flex items-center gap-2 px-4 py-2 cursor-pointer hover:bg-gray-100 text-gray-700" id="viewOnMapMenuItem" role="menuitem" tabindex="0">
    <i class="fas fa-map-marker-alt">
    </i>
    View on Map
   </div>
   <div class="menu-item flex items-center gap-2 px-4 py-2 cursor-pointer hover:bg-gray-100 text-gray-700" id="openInGoogleMapsMenuItem" role="menuitem" tabindex="0">
    <i class="fas fa-external-link-alt">
    </i>
    Open in Maps
   </div>
  </div>
  <!-- Toast -->
  <div aria-live="assertive" class="fixed bottom-16 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-80 text-white px-6 py-3 rounded-lg text-sm opacity-0 pointer-events-none transition-opacity z-50" id="toast" role="alert">
  </div>
  <!-- Floating Action Button -->
  <button aria-label="Add new destination" class="fixed bottom-4 right-4 bg-blue-600 text-white w-14 h-14 rounded-full flex justify-center items-center shadow-lg hover:bg-blue-700 transition z-40" id="fab">
   <i class="fas fa-plus text-xl">
   </i>
  </button>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">
  </script>
  <script>
   document.addEventListener("DOMContentLoaded", function () {
      // Initialize map
      const map = L.map("map").setView([34.0522, -118.2437], 13);

      L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }
      ).addTo(map);

      // Variables
      let locations = [];
      let markers = [];
      let editMode = false;
      let selectedLocationId = null;
      let imageBase64 = null;
      let geocodeTimeout = null;

      // DOM Elements
      const locationList = document.getElementById("locationList");
      const emptyState = document.getElementById("emptyState");
      const addLocationModal = document.getElementById("addLocationModal");
      const locationDetailModal = document.getElementById("locationDetailModal");
      const shareModal = document.getElementById("shareModal");
      const locationForm = document.getElementById("locationForm");
      const imagePreview = document.getElementById("imagePreview");
      const fileInput = document.getElementById("fileInput");
      const editButton = document.getElementById("editButton");
      const doneButton = document.getElementById("doneButton");
      const shareButton = document.getElementById("shareButton");
      const fab = document.getElementById("fab");
      const menuPanel = document.getElementById("menuPanel");
      const toast = document.getElementById("toast");

      // Inputs for coordinates and address
      const inputAddress = document.getElementById("locationAddress");
      const inputLatitude = document.getElementById("locationLatitude");
      const inputLongitude = document.getElementById("locationLongitude");
      const visitedCheckbox = document.getElementById("visitedCheckbox");

      // Working hours inputs
      const workingHoursInputs = {
        Monday: document.getElementById("hoursMonday"),
        Tuesday: document.getElementById("hoursTuesday"),
        Wednesday: document.getElementById("hoursWednesday"),
        Thursday: document.getElementById("hoursThursday"),
        Friday: document.getElementById("hoursFriday"),
        Saturday: document.getElementById("hoursSaturday"),
        Sunday: document.getElementById("hoursSunday"),
      };

      // Load locations from localStorage
      function loadLocations() {
        const storedLocations = localStorage.getItem("mapDestinations");
        if (storedLocations) {
          locations = JSON.parse(storedLocations);
          updateLocationsList();
          updateMapMarkers();
        }

        emptyState.style.display = locations.length > 0 ? "none" : "flex";
        locationList.style.display = locations.length > 0 ? "block" : "none";
      }

      // Save locations to localStorage
      function saveLocations() {
        localStorage.setItem("mapDestinations", JSON.stringify(locations));
        emptyState.style.display = locations.length > 0 ? "none" : "flex";
        locationList.style.display = locations.length > 0 ? "block" : "none";
      }

      // Save visited history to localStorage
      function saveVisitedHistory() {
        const visited = locations.filter((loc) => loc.visited);
        localStorage.setItem("visitedDestinations", JSON.stringify(visited));
      }

      // Calculate distance between two lat/lon points in km using Haversine formula
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const toRad = (value) => (value * Math.PI) / 180;
        const R = 6371; // Earth radius in km
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Update distances in the list and UI
      function updateDistances() {
        // Distances are from previous location in the list; first has no distance
        for (let i = 0; i < locations.length; i++) {
          if (i === 0) {
            locations[i].distanceFromPrevious = null;
          } else {
            const prev = locations[i - 1];
            const curr = locations[i];
            if (
              prev.latitude != null &&
              prev.longitude != null &&
              curr.latitude != null &&
              curr.longitude != null
            ) {
              locations[i].distanceFromPrevious = calculateDistance(
                prev.latitude,
                prev.longitude,
                curr.latitude,
                curr.longitude
              );
            } else {
              locations[i].distanceFromPrevious = null;
            }
          }
        }
      }

      // Update locations list in UI
      function updateLocationsList() {
        updateDistances();
        saveLocations();

        locationList.innerHTML = "";

        locations.forEach((location, index) => {
          const li = document.createElement("li");
          li.className =
            "location-item flex items-center px-4 py-3 cursor-pointer hover:bg-gray-50";
          li.dataset.id = location.id;
          li.setAttribute("draggable", editMode ? "true" : "false");
          li.setAttribute("aria-label", location.name);

          const imageSrc =
            location.image ||
            `https://placehold.co/50x50/png?text=${encodeURIComponent(
              location.name.charAt(0)
            )}`;

          // Distance text
          let distanceText = "";
          if (location.distanceFromPrevious != null) {
            distanceText =
              location.distanceFromPrevious < 1
                ? `${(location.distanceFromPrevious * 1000).toFixed(0)} m`
                : `${location.distanceFromPrevious.toFixed(2)} km`;
          }

          if (editMode) {
            li.innerHTML = `
              <div class="reorder-handle cursor-grab text-gray-400 pr-3" aria-label="Drag handle" tabindex="0"><i class="fas fa-grip-lines"></i></div>
              <input type="checkbox" class="visited-checkbox mr-3 w-5 h-5 cursor-pointer" aria-label="Mark ${location.name} as visited" ${
                location.visited ? "checked" : ""
              } />
              <img src="${imageSrc}" alt="Thumbnail of ${location.name}" class="w-12 h-12 rounded-lg object-cover mr-4 flex-shrink-0" />
              <div class="flex-1 min-w-0">
                <div class="font-semibold truncate">${location.name}</div>
                <div class="text-gray-500 text-xs truncate max-w-xs">${location.address}</div>
                <a href="#" class="view-on-map text-blue-600 text-xs flex items-center gap-1 mt-1" data-id="${location.id}">
                  <i class="fas fa-map-marker-alt"></i> View on map
                </a>
                <div class="text-gray-400 text-xs mt-1">${distanceText ? `Distance from previous: ${distanceText}` : ""}</div>
              </div>
              <div class="location-actions flex-shrink-0 ml-4">
                <button class="icon-button text-red-600 hover:text-red-700" aria-label="Delete ${location.name}" data-id="${location.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            `;

            // Delete button event
            li.querySelector(".icon-button").addEventListener("click", (e) => {
              e.stopPropagation();
              deleteLocation(location.id);
            });

            // Visited checkbox event
            li.querySelector(".visited-checkbox").addEventListener("click", (e) => {
              e.stopPropagation();
              location.visited = e.target.checked;
              saveLocations();
              saveVisitedHistory();
            });
          } else {
            li.innerHTML = `
              <input type="checkbox" class="visited-checkbox mr-3 w-5 h-5 cursor-pointer" aria-label="Mark ${location.name} as visited" ${
                location.visited ? "checked" : ""
              } />
              <img src="${imageSrc}" alt="Thumbnail of ${location.name}" class="w-12 h-12 rounded-lg object-cover mr-4 flex-shrink-0" />
              <div class="flex-1 min-w-0">
                <div class="font-semibold truncate">${location.name}</div>
                <div class="text-gray-500 text-xs truncate max-w-xs">${location.address}</div>
                <a href="#" class="view-on-map text-blue-600 text-xs flex items-center gap-1 mt-1" data-id="${location.id}">
                  <i class="fas fa-map-marker-alt"></i> View on map
                </a>
                <div class="text-gray-400 text-xs mt-1">${distanceText ? `Distance from previous: ${distanceText}` : ""}</div>
              </div>
              <div class="location-actions flex-shrink-0 ml-4">
                <button class="icon-button text-gray-600 hover:text-gray-800" aria-label="Options for ${location.name}" data-id="${location.id}">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
              </div>
            `;

            // Menu button event
            li.querySelector(".icon-button").addEventListener("click", (e) => {
              e.stopPropagation();
              showMenu(e, location.id);
            });

            // Visited checkbox event
            li.querySelector(".visited-checkbox").addEventListener("click", (e) => {
              e.stopPropagation();
              location.visited = e.target.checked;
              saveLocations();
              saveVisitedHistory();
            });
          }

          // View on map event
          li.querySelector(".view-on-map").addEventListener("click", (e) => {
            e.stopPropagation();
            viewLocationOnMap(location.id);
          });

          // Click event to open location details
          li.addEventListener("click", () => {
            showLocationDetails(location.id);
          });

          locationList.appendChild(li);
        });
      }

      // Update map markers
      function updateMapMarkers() {
        markers.forEach((marker) => map.removeLayer(marker));
        markers = [];

        locations.forEach((location) => {
          if (location.latitude && location.longitude) {
            const marker = L.marker([location.latitude, location.longitude])
              .addTo(map)
              .bindPopup(`<b>${location.name}</b><br>${location.address}`);

            marker.on("click", () => {
              showLocationDetails(location.id);
            });

            markers.push(marker);
          }
        });

        if (markers.length > 0) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }
      }

      // Toggle edit mode
      function toggleEditMode() {
        editMode = !editMode;

        if (editMode) {
          editButton.classList.add("hidden");
          document.querySelector(".edit-buttons").classList.remove("hidden");
          locationList.classList.add("edit-mode");
        } else {
          editButton.classList.remove("hidden");
          document.querySelector(".edit-buttons").classList.add("hidden");
          locationList.classList.remove("edit-mode");
        }

        updateLocationsList();
      }

      // Show menu for location
      function showMenu(event, locationId) {
        const rect = event.target.getBoundingClientRect();
        menuPanel.style.top = `${rect.bottom + window.scrollY + 5}px`;
        menuPanel.style.left = `${rect.left + window.scrollX}px`;
        menuPanel.style.display = "block";
        selectedLocationId = locationId;

        setTimeout(() => {
          document.addEventListener("click", closeMenuOnClick);
        }, 100);
      }

      // Close menu when clicking outside
      function closeMenuOnClick(e) {
        if (!menuPanel.contains(e.target)) {
          menuPanel.style.display = "none";
          document.removeEventListener("click", closeMenuOnClick);
        }
      }

      // Show location details modal
      function showLocationDetails(locationId) {
        const location = locations.find((loc) => loc.id === locationId);
        if (!location) return;

        document.getElementById("detailName").textContent = location.name;
        const detailAddress = document.getElementById("detailAddress");
        detailAddress.textContent = location.address || "No address provided";
        detailAddress.href = location.latitude && location.longitude
          ? `https://www.google.com/maps/search/?api=1&query=${location.latitude},${location.longitude}`
          : "#";
        document.getElementById("detailDescription").textContent =
          location.description || "No description";
        document.getElementById(
          "detailCoords"
        ).textContent = location.latitude && location.longitude
          ? `Coordinates: ${location.latitude}, ${location.longitude}`
          : "Coordinates not available";

        const detailImage = document.getElementById("detailImage");
        detailImage.src =
          location.image ||
          `https://placehold.co/400x320/png?text=${encodeURIComponent(
            location.name.charAt(0)
          )}`;
        detailImage.alt = `Image of ${location.name}`;

        // Show working hours in detail modal
        const detailWorkingHours = document.getElementById("detailWorkingHours");
        detailWorkingHours.innerHTML = "";
        if (location.workingHours) {
          for (const [day, hours] of Object.entries(location.workingHours)) {
            const li = document.createElement("li");
            li.textContent = `${day}: ${hours || "Closed"}`;
            detailWorkingHours.appendChild(li);
          }
        } else {
          const li = document.createElement("li");
          li.textContent = "No working hours set";
          detailWorkingHours.appendChild(li);
        }

        const mapsUrl = location.latitude && location.longitude
          ? `https://www.google.com/maps/search/?api=1&query=${location.latitude},${location.longitude}`
          : null;
        document.getElementById("openInGoogleMapsButton").onclick = () => {
          if (mapsUrl) window.open(mapsUrl, "_blank", "noopener");
          else showToast("Coordinates not available");
        };

        document.getElementById("viewOnMapButton").onclick = () => {
          if (location.latitude && location.longitude) {
            viewLocationOnMap(locationId);
            closeModal(locationDetailModal);
          } else {
            showToast("Coordinates not available");
          }
        };

        locationDetailModal.style.display = "flex";
        selectedLocationId = locationId;
      }

      // View location on map
      function viewLocationOnMap(locationId) {
        const location = locations.find((loc) => loc.id === locationId);
        if (!location || !location.latitude || !location.longitude) {
          showToast("Location coordinates not available");
          return;
        }

        map.setView([location.latitude, location.longitude], 16);

        markers.forEach((marker) => {
          const markerLatLng = marker.getLatLng();
          if (
            markerLatLng.lat === location.latitude &&
            markerLatLng.lng === location.longitude
          ) {
            marker.openPopup();
          }
        });
      }

      // Delete location
      function deleteLocation(locationId) {
        if (confirm("Are you sure you want to delete this location?")) {
          locations = locations.filter((loc) => loc.id !== locationId);
          saveLocations();
          saveVisitedHistory();
          updateLocationsList();
          updateMapMarkers();
          showToast("Location deleted");
        }
      }

      // Show toast notification
      function showToast(message) {
        toast.textContent = message;
        toast.style.opacity = 1;
        toast.style.pointerEvents = "auto";

        setTimeout(() => {
          toast.style.opacity = 0;
          toast.style.pointerEvents = "none";
        }, 3000);
      }

      // Close modal
      function closeModal(modal) {
        modal.style.display = "none";
        if (modal === addLocationModal) {
          locationForm.reset();
          imageBase64 = null;
          imagePreview.innerHTML = `
            <div class="flex flex-col items-center text-gray-400 text-sm select-none">
              <i class="fas fa-image text-3xl mb-1"></i>
              <span>Tap to add image</span>
            </div>
          `;
          // Clear coordinates and address fields
          inputLatitude.value = "";
          inputLongitude.value = "";
          inputAddress.value = "";
          visitedCheckbox.checked = false;
          // Clear working hours inputs
          for (const day in workingHoursInputs) {
            workingHoursInputs[day].value = "";
          }
          addLocationModal.querySelector(".modal-title").textContent =
            "Add New Destination";
        }
      }

      // Generate unique ID
      function generateId() {
        return (
          Date.now().toString(36) + Math.random().toString(36).substring(2, 8)
        );
      }

      // Geocode address to get coordinates
      async function geocodeAddress(address) {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              address
            )}&limit=1`
          );
          const data = await response.json();

          if (data && data.length > 0) {
            return {
              latitude: parseFloat(data[0].lat),
              longitude: parseFloat(data[0].lon),
              display_name: data[0].display_name,
            };
          } else {
            throw new Error("Location not found");
          }
        } catch (error) {
          console.error("Geocoding error:", error);
          showToast("Could not get coordinates for this address");
          return null;
        }
      }

      // Reverse geocode coordinates to get address
      async function reverseGeocode(lat, lon) {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
          );
          const data = await response.json();

          if (data && data.display_name) {
            return data.display_name;
          } else {
            throw new Error("Address not found");
          }
        } catch (error) {
          console.error("Reverse geocoding error:", error);
          showToast("Could not get address for these coordinates");
          return null;
        }
      }

      // Debounce helper
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Sync address to coordinates
      const syncAddressToCoords = debounce(async () => {
        const address = inputAddress.value.trim();
        if (!address) return;
        const coords = await geocodeAddress(address);
        if (coords) {
          inputLatitude.value = coords.latitude.toFixed(6);
          inputLongitude.value = coords.longitude.toFixed(6);
          // Optionally update address to formatted display_name
          inputAddress.value = coords.display_name;
        }
      }, 700);

      // Sync coordinates to address
      const syncCoordsToAddress = debounce(async () => {
        const lat = parseFloat(inputLatitude.value);
        const lon = parseFloat(inputLongitude.value);
        if (
          isNaN(lat) ||
          isNaN(lon) ||
          lat < -90 ||
          lat > 90 ||
          lon < -180 ||
          lon > 180
        )
          return;
        const address = await reverseGeocode(lat, lon);
        if (address) {
          inputAddress.value = address;
        }
      }, 700);

      // Attach event listeners for syncing
      inputAddress.addEventListener("input", () => {
        // Clear coords if user is typing address
        inputLatitude.value = "";
        inputLongitude.value = "";
        syncAddressToCoords();
      });

      inputLatitude.addEventListener("input", () => {
        syncCoordsToAddress();
      });

      inputLongitude.addEventListener("input", () => {
        syncCoordsToAddress();
      });

      // Export locations as PDF
      function exportAsPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text("My Destinations", 20, 20);

        let y = 40;
        locations.forEach((loc, index) => {
          if (y > 250) {
            doc.addPage();
            y = 20;
          }

          doc.setFontSize(14);
          doc.text(`${index + 1}. ${loc.name}`, 20, y);
          y += 10;

          doc.setFontSize(10);
          doc.text(`Address: ${loc.address || "N/A"}`, 25, y);
          y += 5;

          if (loc.description) {
            const descLines = doc.splitTextToSize(
              `Description: ${loc.description}`,
              160
            );
            descLines.forEach((line) => {
              y += 5;
              doc.text(line, 25, y);
            });
          }

          doc.text(
            `Coordinates: ${loc.latitude || "N/A"}, ${loc.longitude || "N/A"}`,
            25,
            y + 5
          );
          y += 10;

          if (loc.workingHours) {
            doc.text("Working Hours:", 25, y);
            y += 7;
            for (const [day, hours] of Object.entries(loc.workingHours)) {
              doc.text(`  ${day}: ${hours || "Closed"}`, 30, y);
              y += 7;
              if (y > 250) {
                doc.addPage();
                y = 20;
              }
            }
            y += 5;
          } else {
            y += 5;
          }

          if (loc.distanceFromPrevious != null) {
            const distText =
              loc.distanceFromPrevious < 1
                ? `${(loc.distanceFromPrevious * 1000).toFixed(0)} m`
                : `${loc.distanceFromPrevious.toFixed(2)} km`;
            doc.text(`Distance from previous: ${distText}`, 25, y);
            y += 10;
          }

          if (loc.visited) {
            doc.text("Visited: Yes", 25, y);
            y += 10;
          }
        });

        doc.save("my-destinations.pdf");
        closeModal(shareModal);
        showToast("PDF exported successfully");
      }

      // Export locations as JSON
      function exportAsJSON() {
        const dataStr = JSON.stringify(locations, null, 2);
        const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

        const exportName = "my-destinations.json";

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportName);
        linkElement.click();

        closeModal(shareModal);
        showToast("JSON exported successfully");
      }

      // Export locations as text
      function exportAsText() {
        let text = "MY DESTINATIONS\n\n";

        locations.forEach((loc, index) => {
          text += `${index + 1}. ${loc.name}\n`;
          text += `   Address: ${loc.address || "N/A"}\n`;
          if (loc.description) {
            text += `   Description: ${loc.description}\n`;
          }
          text += `   Coordinates: ${loc.latitude || "N/A"}, ${loc.longitude || "N/A"}\n`;
          if (loc.workingHours) {
            text += "   Working Hours:\n";
            for (const [day, hours] of Object.entries(loc.workingHours)) {
              text += `     ${day}: ${hours || "Closed"}\n`;
            }
          }
          if (loc.distanceFromPrevious != null) {
            const distText =
              loc.distanceFromPrevious < 1
                ? `${(loc.distanceFromPrevious * 1000).toFixed(0)} m`
                : `${loc.distanceFromPrevious.toFixed(2)} km`;
            text += `   Distance from previous: ${distText}\n`;
          }
          if (loc.visited) {
            text += "   Visited: Yes\n";
          }
          text += "\n";
        });

        const dataUri = "data:text/plain;charset=utf-8," + encodeURIComponent(text);
        const exportName = "my-destinations.txt";

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportName);
        linkElement.click();

        closeModal(shareModal);
        showToast("Text exported successfully");
      }

      // File input change handler
      fileInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!file.type.match("image.*")) {
          showToast("Please select an image file");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          imageBase64 = e.target.result;
          imagePreview.innerHTML = `<img src="${imageBase64}" alt="Preview image" class="w-full h-full object-cover rounded-lg" />`;
        };
        reader.readAsDataURL(file);
      });

      // Make image preview clickable to trigger file input
      imagePreview.addEventListener("click", function () {
        fileInput.click();
      });
      imagePreview.addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          fileInput.click();
        }
      });

      // Modal dismiss buttons
      document.querySelectorAll('[data-dismiss="modal"]').forEach((button) => {
        button.addEventListener("click", () => {
          const modal = button.closest(".modal") || button.closest("div[role='dialog']");
          if (modal) closeModal(modal);
        });
      });

      // Add location form submit
      locationForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const nameInput = document.getElementById("locationName");
        const addressVal = inputAddress.value.trim();
        const latVal = inputLatitude.value.trim();
        const lonVal = inputLongitude.value.trim();
        const descriptionInput = document.getElementById("locationDescription");
        const visitedVal = visitedCheckbox.checked;

        if (!nameInput.value.trim()) {
          showToast("Please fill in the name field");
          return;
        }

        // Validate coordinates if provided
        let latitude = null;
        let longitude = null;
        if (latVal !== "" && lonVal !== "") {
          latitude = parseFloat(latVal);
          longitude = parseFloat(lonVal);
          if (
            isNaN(latitude) ||
            isNaN(longitude) ||
            latitude < -90 ||
            latitude > 90 ||
            longitude < -180 ||
            longitude > 180
          ) {
            showToast("Please enter valid latitude and longitude");
            return;
          }
        }

        // If coordinates provided but no address, reverse geocode
        let address = addressVal;
        if ((!address || address === "") && latitude !== null && longitude !== null) {
          const revAddress = await reverseGeocode(latitude, longitude);
          if (revAddress) {
            address = revAddress;
          }
        }

        // If address provided but no coordinates, geocode
        if (
          (latitude === null || longitude === null) &&
          address &&
          address !== ""
        ) {
          const coords = await geocodeAddress(address);
          if (!coords) return;
          latitude = coords.latitude;
          longitude = coords.longitude;
          address = coords.display_name;
        }

        if (latitude === null || longitude === null) {
          showToast("Please provide either valid coordinates or address");
          return;
        }

        // Gather working hours
        const workingHours = {};
        for (const day in workingHoursInputs) {
          workingHours[day] = workingHoursInputs[day].value.trim() || "Closed";
        }

        if (selectedLocationId) {
          const index = locations.findIndex((loc) => loc.id === selectedLocationId);
          if (index !== -1) {
            locations[index] = {
              ...locations[index],
              name: nameInput.value.trim(),
              address,
              description: descriptionInput.value.trim(),
              latitude,
              longitude,
              workingHours,
              visited: visitedVal,
              ...(imageBase64 ? { image: imageBase64 } : {}),
            };
            showToast("Location updated successfully");
          }
        } else {
          const newLocation = {
            id: generateId(),
            name: nameInput.value.trim(),
            address,
            description: descriptionInput.value.trim(),
            latitude,
            longitude,
            workingHours,
            visited: visitedVal,
            image: imageBase64,
          };

          locations.push(newLocation);
          showToast("Location added successfully");
        }

        saveLocations();
        saveVisitedHistory();
        updateLocationsList();
        updateMapMarkers();
        closeModal(addLocationModal);

        selectedLocationId = null;
        imageBase64 = null;
      });

      // FAB click to open add location modal
      fab.addEventListener("click", () => {
        selectedLocationId = null;
        addLocationModal.style.display = "flex";
        addLocationModal.querySelector(".modal-title").textContent =
          "Add New Destination";
      });

      // Edit and Done buttons toggle edit mode
      editButton.addEventListener("click", toggleEditMode);
      doneButton.addEventListener("click", toggleEditMode);

      // Share button opens share modal
      shareButton.addEventListener("click", () => {
        shareModal.style.display = "flex";
      });

      // Export buttons
      document.getElementById("exportPdfButton").addEventListener("click", exportAsPDF);
      document.getElementById("exportJsonButton").addEventListener("click", exportAsJSON);
      document.getElementById("exportTextButton").addEventListener("click", exportAsText);

      // Menu item event listeners
      document.getElementById("editMenuItem").addEventListener("click", () => {
        const location = locations.find((loc) => loc.id === selectedLocationId);
        if (!location) return;

        document.getElementById("locationName").value = location.name;
        inputAddress.value = location.address || "";
        inputLatitude.value = location.latitude !== undefined ? location.latitude : "";
        inputLongitude.value = location.longitude !== undefined ? location.longitude : "";
        document.getElementById("locationDescription").value = location.description || "";
        visitedCheckbox.checked = location.visited || false;

        if (location.workingHours) {
          for (const day in workingHoursInputs) {
            workingHoursInputs[day].value = location.workingHours[day] || "";
          }
        } else {
          for (const day in workingHoursInputs) {
            workingHoursInputs[day].value = "";
          }
        }

        if (location.image) {
          imageBase64 = location.image;
          imagePreview.innerHTML = `<img src="${location.image}" alt="Preview image" class="w-full h-full object-cover rounded-lg" />`;
        } else {
          imageBase64 = null;
          imagePreview.innerHTML = `
            <div class="flex flex-col items-center text-gray-400 text-sm select-none">
              <i class="fas fa-image text-3xl mb-1"></i>
              <span>Tap to add image</span>
            </div>
          `;
        }

        addLocationModal.querySelector(".modal-title").textContent = "Edit Destination";
        addLocationModal.style.display = "flex";
        menuPanel.style.display = "none";
      });

      document.getElementById("deleteMenuItem").addEventListener("click", () => {
        deleteLocation(selectedLocationId);
        menuPanel.style.display = "none";
      });

      document.getElementById("viewOnMapMenuItem").addEventListener("click", () => {
        viewLocationOnMap(selectedLocationId);
        menuPanel.style.display = "none";
      });

      document.getElementById("openInGoogleMapsMenuItem").addEventListener("click", () => {
        const location = locations.find((loc) => loc.id === selectedLocationId);
        if (!location || !location.latitude || !location.longitude) {
          showToast("Location coordinates not available");
          return;
        }

        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${location.latitude},${location.longitude}`;
        window.open(mapsUrl, "_blank", "noopener");
        menuPanel.style.display = "none";
      });

      // Drag and drop reordering in edit mode
      let draggedItem = null;

      function enableDragAndDrop() {
        document.addEventListener("dragstart", function (e) {
          if (!editMode) return;

          const target = e.target.closest(".location-item");
          if (!target) return;

          draggedItem = target;
          setTimeout(() => {
            target.classList.add("opacity-70", "bg-gray-100");
          }, 0);
        });

        document.addEventListener("dragend", function (e) {
          if (!editMode) return;

          const target = e.target.closest(".location-item");
          if (!target) return;

          target.classList.remove("opacity-70", "bg-gray-100");
          draggedItem = null;
          // After drag end, update order and distances
          const list = document.getElementById("locationList");
          const newOrder = Array.from(list.querySelectorAll(".location-item")).map(
            (item) => item.dataset.id
          );
          locations = newOrder.map((id) => locations.find((loc) => loc.id === id));
          updateDistances();
          saveLocations();
          saveVisitedHistory();
          updateLocationsList();
          updateMapMarkers();
        });

        document.addEventListener("dragover", function (e) {
          e.preventDefault();
          if (!editMode || !draggedItem) return;

          const list = document.getElementById("locationList");
          const listItems = Array.from(
            list.querySelectorAll(".location-item:not(.opacity-70)")
          );

          const targetItem = listItems.find((item) => {
            const rect = item.getBoundingClientRect();
            return e.clientY < rect.bottom;
          });

          if (targetItem) {
            list.insertBefore(draggedItem, targetItem);
          } else {
            list.appendChild(draggedItem);
          }
        });
      }

      // Initialize app
      loadLocations();
      enableDragAndDrop();

      // Save locations before unload
      window.addEventListener("beforeunload", function () {
        saveLocations();
        saveVisitedHistory();
      });

      // Register service worker for offline capabilities
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then(function () {
            console.log("Service Worker registered");
          })
          .catch(function (error) {
            console.log("Service Worker registration failed:", error);
          });
      }
    });
  </script>
 </body>
</html>